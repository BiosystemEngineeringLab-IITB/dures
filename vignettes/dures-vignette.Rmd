---
title: "Demonstration of the package dures"
author: "Shayantan Banerje\e"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Demonstration of the package dures}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Suppress title check if necessary
options(rmarkdown.html_vignette.check_title = FALSE)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The **Denoising Using Replicate Spectra (DuReS)** package requires the following input parameters:

- A folder path to store all the data and analysis results.
- A folder named `mzml_files/` within the above folder path, containing files in the mzML format.
- A features file containing a list of MS/MS features derived from standard untargeted metabolomics analysis software. This file must satisfy one of the following requirements:
  - **Option 1**: A single file named `feature_list.txt` with columns “ID”, “mz”, and “RT”. In this case, a fixed but customizable RT and mz tolerance will be used to extract the MS/MS spectra.
  - **Option 2**: Both:
    - A `feature_list.txt` file in the format described above, and
    - A RT tolerance file named `Sample-and_feature-wise-RT-tolerance.txt` containing custom RT tolerances for each sample. For example:
      - If there are two samples (`sample_1` and `sample_2`), the `Sample-and_feature-wise-RT-tolerance.txt` file should have the same number of rows as `feature_list.txt`.
      - The column names should be formatted as `RT_min_sample_1`, `RT_min_sample_2`, `RT_max_sample_1`, and `RT_max_sample_2`.


## Test Datasets

All the test datasets used in this vignette are hosted at [https://zenodo.org/records/13778168](https://zenodo.org/records/13778168). Users need to download the file and unzip the folder contents on their local system.

- The `test_1` folder contains a folder named `mzml_files/` and two files: `Sample-and-feature-wise-RT-tolerance.txt` and `feature_list.txt`. The `feature_list.txt` file has three columns: "ID", "mz", and "RT". The additional file `Sample-and-feature-wise-RT-tolerance.txt` contains the sample-wise RT tolerances for all features. The number of rows in both files is the same, while the `Sample-and-feature-wise-RT-tolerance.txt` file has twice as many columns as `feature_list.txt`, with `RT_min_` and `RT_max_` appended to every sample name.
  
- The `test_2` and `test_3` folders each contain a folder named `mzml_files/` and a file named `feature_list.txt`.


## Install the dependencies
```{r initial-setup, eval=FALSE}
# Dependencies
install.packages("BiocManager", quiet = TRUE)
BiocManager::install(c("Spectra", "S4Vectors", "mzR"), quiet = TRUE)

if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools", quiet = TRUE)
}
```

## Install the package
```{r initial-setup-contd, eval=TRUE}
devtools::install_github("BiosystemEngineeringLab-IITB/dures")
library(dures)
library(Spectra)
library(mzR)
```

## First Test Example
This test dataset can be downloaded from the data deposited at [Zenodo](https://zenodo.org/records/13778168) (folder name: test_1/). The first step of the workflow focuses on reading mzML files, extracting MS/MS spectra within the specified mz and RT tolerance and concatenating all the replicate spectra for a given feature. The features for which no MS/MS spectra could be extracted given the RT and mz tolerance are removed from the list. 
```{r, execute first step of the workflow}
# Define the path to the test_1 folder (replace with the actual path on your system)
folder_path <- "~/Desktop/test_package_dures/test_1/"
# Check if the directory exists
if (!dir.exists(folder_path)) {
  stop("The directory 'test_1' does not exist. Please modify the path to the actual location of the 'test_1' folder.")
}
l1 = preprocess(folder_path = folder_path, tol_mz = 5, tol_rt = 0.1)
```
`l1` is a list containing two elements: `stats_file_ms2_only` containing a dataframe with the MS/MS feature information - `ID, mz, RT, mz_up, mz_down and RT_tolerance` (for every samples) and `spectra_ms2_only` containing an Spectra object with the replicate spectra concatenated for every feature. Let us look at the concatenated spectra for the first feature.

```{r first element}
cat("name of first feature\n")
names(l1$spectra_ms2_only)[1] #name of the first feature
l1$spectra_ms2_only[[1]]
```
```{r second}
cat("name of third feature\n")
names(l1$spectra_ms2_only)[3] #name of the first feature
l1$spectra_ms2_only[[3]]
```
From the output we can see that the first two MS2 features `1982` and `872` has 83 and 43 MS/MS spectra from different samples listed in `file(s)` section of the output. We can quickly take a look at the peak information of the first two out of the 83 raw MS/MS spectra using the `peaksData()` command. Please make sure the Spectra package in loaded in your workspace.

```{r peaksdata}
peaksData(l1$spectra_ms2_only[[1]]$aggregate)[[1]] #first replicate spectrum
peaksData(l1$spectra_ms2_only[[2]]$aggregate)[[1]] #second replicate spectrum
```
It is also worth noting that we keep track of the individual spectrum in terms of the sample it is derived from. This is demonstrated as follows through the identities of the first 10 replicate spectra:

```{r spectrum identity}
l1$spectra_ms2_only[[1]]$aggregate$spectrumId[1:10] #will be a vector of length 83
```
For demonstration purposes, we will consider the first spectrum of the list named `20092020_CovidMild_P291_P_2.mzML_scan_1504`. This spectrum is derived from the sample `20092020_CovidMild_P291_P_2.mzML`. As we have seen in the previous code block, this spectrum has 19 fragments. Similarly, the second spectrum titled `20092020_CovidMild_P291_P_2.mzML_scan_1541` has 46 fragments. We will see in the end how many fragments remain in these two spectra after we apply fixed frequency cutoff to demonstrate the effect of denoising.  

In the second step, we will use `l1` as input from the previous step and extract the top x% TIC spectra and groups fragments within a specified mass tolerance. The user can change the top x% TIC value and the mass tolerance (default is 0.8 or 80% and 0.05 Da). The length

```{r second step}
l2 = extract_raw_spectra(folder_path = folder_path, l1, 0.05, 0.8)
```
For the same number of MS/MS features present in `l1`, the output from the second step `l2` contain three components - the top x% TIC spectra titled `sps_top_tic_2` (in Spectra format), a dataframe `df` containing the number of spectra before and after applying the top x% TIC cutoff and a vector containing features for which no spectra could be extracted. Let us look at the first and third rows of `df` and the number of spectra for the first and third feature after applying the TIC cutoff. The feature IDs are `1982` and `872` respectively. 

```{r intra}
l2$df[c(1,3),]
print(l2$sps_top_tic_2[[1]]) # From 83 before to 66 spectra after after top x% TIC
print(l2$sps_top_tic_2[[3]]) # From 43 before to 34 spectra remain after top x% TIC
```
We will also take a look at the peak value for the first two spectra belonging to the feature ID `1982`. Due the intra-spectra grouping, we can clearly see a reduction in the number of peaks. But before that, we need to check the identity of the spectra to make sure we are comparing the same spectra before and after step 2 of the analysis.

```{r compare_spectra}
print(l1$spectra_ms2_only[[1]]$aggregate$spectrumId[1:10]) #spectra identities before step 2
print(l2$sps_top_tic_2[[1]]$spectrumId[1:10]) #spectra identitied after x% TIC cutoff implementation in step 2
```
It is clear from this output that some spectra has been eliminated owing to low TIC. Example, `20092020_CovidMild_P291_P_2.mzML_scan_1504` didn't exist after application of top 80% TIC cutoff. 

```{r peaksdata_after_intra}
peaksData(l2$sps_top_tic_2[[1]])[[1]] #first replicate spectrum
peaksData(l2$sps_top_tic_2[[2]])[[1]] #second replicate spectrum
```
